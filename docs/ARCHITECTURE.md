# Wallet 系统架构

## 📐 总体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        外部接口层                                 │
│                     (cmd/server)                                │
│  HTTP API / gRPC API / WebSocket                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        业务服务层                                 │
│                     (internal/service)                          │
│  WalletService | TransactionService | ChainService              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────┬──────────────┬──────────────┬──────────────┬─────┐
│   扫块模块    │   转账模块    │   归集模块    │   入账模块    │ 风控 │
│   Scanner    │   Transfer   │   Collect    │   Deposit    │ Risk │
│(internal/)   │(internal/)   │(internal/)   │(internal/)   │(int.)│
└──────────────┴──────────────┴──────────────┴──────────────┴─────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        公共库层                                   │
│                        (pkg/)                                   │
│  Gas估算 | 链客户端 | 签名 | 加密 | 工具                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据访问层                                 │
│                     (internal/repository)                       │
│  TransactionRepo | AddressRepo | BalanceRepo                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储                                   │
│            PostgreSQL / MySQL / Redis                           │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 核心模块

### 1. 扫块模块 (Scanner)

**职责**: 实时监控区块链，检测相关交易

**功能**:
- 按区块高度顺序扫描
- 支持多链并发扫描
- 可配置确认区块数
- 交易过滤和分类

**使用场景**:
- 检测充值（入账）
- 监控转账状态
- 风险交易预警

### 2. 转账模块 (Transfer)

**职责**: 安全地发送链上交易

**功能**:
- 自动估算 gas 费用
- 交易签名和发送
- 交易状态追踪
- 支持批量转账
- 失败重试机制

**使用场景**:
- 用户提现
- 内部转账
- 批量发放

### 3. 归集模块 (Collect)

**职责**: 自动归集分散资金到冷钱包

**功能**:
- 定时检查热钱包余额
- 按策略触发归集
- 保留必要的 gas 费
- 归集记录和审计

**归集策略**:
- 余额阈值触发
- 定时归集
- 手动归集

### 4. 入账模块 (Deposit)

**职责**: 检测和确认用户充值

**功能**:
- 监听充值地址
- 区块确认机制
- 充值通知
- 重复充值检测

**确认流程**:
```
交易检测 → 等待N个确认 → 入账 → 通知用户
```

### 5. 风控模块 (Risk)

**职责**: 多维度风险控制

**功能**:
- 黑白名单管理
- 单笔/每日限额
- 异常交易检测
- 人工审批流程

**风控规则**:
- 地址黑名单检查
- 金额限制检查
- 频率限制检查
- 大额人工审批

## 🔐 安全设计

### 私钥管理

```
┌──────────────┐
│  私钥存储方式  │
├──────────────┤
│ 1. 加密文件   │ → 本地开发
│ 2. 数据库加密 │ → 小规模生产
│ 3. KMS       │ → 企业级生产（推荐）
│ 4. HSM       │ → 高安全要求
└──────────────┘
```

### 签名隔离

- API 服务器不存储私钥
- 签名服务独立部署
- 内网通信
- 审计日志

## 📊 数据库设计

### 核心表

```sql
-- 地址表
addresses (
  id, address, chain_id, private_key_encrypted,
  created_at, updated_at
)

-- 交易表
transactions (
  id, tx_hash, chain_id, from_address, to_address,
  amount, status, block_number, created_at
)

-- 充值表
deposits (
  id, tx_hash, address, amount, confirm_count,
  status, notified_at, created_at
)

-- 风控日志
risk_logs (
  id, address, action, risk_level, reason,
  created_at
)
```

## 🚀 部署架构

```
┌─────────────┐
│  负载均衡    │
│   (Nginx)   │
└──────┬──────┘
       │
       ├─────┬─────┬─────┐
       ↓     ↓     ↓     ↓
    [API] [API] [API] [API]  ← 无状态，可水平扩展
       │
       ↓
┌─────────────┐
│   数据库     │
│ (主从复制)   │
└─────────────┘

独立部署:
[Worker1] → ETH Scanner
[Worker2] → BSC Scanner
[Worker3] → Collector
```

## 🔧 配置管理

- 开发环境: `config.dev.yaml`
- 生产环境: `config.prod.yaml`
- 敏感配置: 环境变量 / KMS

## 📈 监控告警

- 系统指标: CPU、内存、磁盘
- 业务指标: 扫块延迟、交易成功率
- 告警渠道: 钉钉、邮件、短信

## 🔄 扩展性

### 支持新链

1. 添加链配置到 `config.yaml`
2. 实现 `pkg/chain` 接口（如果是非 EVM 链）
3. 部署新的 Scanner Worker

### 支持代币

1. 添加 ERC20 合约解析
2. 更新 Scanner 过滤逻辑
3. 修改数据库 schema
